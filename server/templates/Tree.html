<!DOCTYPE html>
<html lang="id">

<head>
  <link rel="icon" href="/static/favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeDevour</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f3f4f6;
      font-family: 'Inter', sans-serif;
    }

    .container {
      max-width: 1150px;
    }

    .panel {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
    }

    .fade-in {
      animation: fadeIn 0.35s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .collapsible-header {
      cursor: default;
    }

    .toggle-icon-container {
      cursor: pointer;
      padding-right: 8px;
    }

    .collapsible-content {
      display: none;
      overflow: hidden;
      transition: all 0.3s ease-in-out;
    }

    .drop-target {
      outline: 2px dashed #3b82f6;
      outline-offset: 4px;
      background: #eff6ff;
    }

    .folder-icon {
      transition: transform 0.3s ease-in-out;
    }

    .rotated {
      transform: rotate(90deg);
    }

    .tab-button {
      border-bottom: 2px solid transparent;
    }

    /* === Crimson theme (Devour) === */
    .primary-red {
      color: #7A0014;
    }

    .bg-primary-red {
      background-color: #7A0014;
    }

    .btn-primary {
      background-color: #7A0014;
      color: #fff;
      transition: all .2s ease;
    }

    .btn-primary:hover {
      background-color: #60000F;
      box-shadow: 0 4px 12px rgba(122, 0, 20, .3);
    }

    .btn-primary:active {
      background-color: #4a000d;
      transform: translateY(1px);
    }

    .btn-secondary {
      border: 1px solid #d1d5db;
      background: #fff;
      transition: all .2s ease;
    }

    .btn-secondary:hover {
      border-color: #9ca3af;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
    }

    /* Tab aktif = crimson */
    .tab-button.active {
      border-color: #7A0014 !important;
      color: #7A0014 !important;
      font-weight: 600;
    }

    /* Top nav chips */
    .nav-chip {
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      padding: .4rem .9rem;
      font-size: .875rem;
      transition: all .2s ease;
      background: #fff;
      color: #374151;
    }

    .nav-chip:hover {
      background: #f3f4f6;
    }

    .nav-chip.active {
      background: #7A0014;
      color: #F7F7F8;
      border-color: #7A0014;
    }
  </style>
</head>

<body class="p-6">

  <!-- Top Nav (desktop only) -->
  <div class="container mx-auto mb-4">
    <div class="bg-white border border-gray-200 rounded-xl px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-bold text-gray-800">
        Code<span class="primary-red">Devour</span> <span class="text-sm primary-red">‚ö°</span>
      </h1>
      <div class="flex gap-2">
        <button class="nav-chip active" data-target="#names-panel">NamesExtractor</button>
        <button class="nav-chip" data-target="#text-extractor-tab">TextExtractor</button>
        <button class="nav-chip" data-target="#exclude-me-tab">Exclude Me</button>
        <button class="nav-chip" data-target="#just-me-tab">Just Me</button>
        <button class="nav-chip" data-target="#status-panel">Activity Log</button>
      </div>
    </div>
  </div>

  <div class="container mx-auto bg-white p-8 rounded-xl shadow-lg flex flex-col space-y-8">
    <div class="flex items-center space-x-4 bg-white shadow-lg rounded-xl p-6 border border-gray-200">
      <h1 class="text-xl font-bold text-gray-800">Path Project:</h1>
      <input type="text" id="project-path-input" placeholder="Masukkan path folder di sini..."
        class="flex-grow p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button id="pick-folder-btn" class="btn-secondary font-bold py-2 px-4 rounded-md">Pilih Folder‚Ä¶</button>
      <button id="set-path-btn" class="btn-primary font-bold py-2 px-4 rounded-md">Set Path</button>
    </div>

    <div class="flex w-full items-stretch space-x-8">
      <!-- Panel Kiri -->
      <div id="names-panel" class="panel flex-1 basis-1/2 min-w-0">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">NamesExtractor</h2>
        <p class="text-sm text-gray-600 mb-4">Pilih opsi di bawah untuk membuat daftar file dan folder di project Anda.
        </p>
        <p class="text-xs text-gray-500 mb-3">Tips: tarik nama file/folder ke tab <strong>Exclude Me</strong> untuk
          menambah pengecualian.</p>

        <div class="mb-4 space-y-2">
          <label class="inline-flex items-center">
            <input type="checkbox" id="include-files-checkbox" class="form-checkbox text-blue-500 rounded" checked>
            <span class="ml-2">Sertakan File</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" id="include-size-checkbox" class="form-checkbox text-blue-500 rounded">
            <span class="ml-2">Sertakan Ukuran</span>
          </label>
        </div>

        <button id="run-name-extractor-btn"
          class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md focus:ring-2 transition-colors">
          Jalankan NamesExtractor.py
        </button>

        <div id="file-tree"
          class="mt-4 space-y-2 h-96 overflow-y-auto border border-gray-300 p-4 rounded-md bg-gray-50">
          <div class="text-center text-sm font-medium text-gray-500">
            Input path dan jalankan NamesExtractor.py untuk melihat struktur.
          </div>
        </div>
      </div>

      <!-- Panel Kanan -->
      <div class="panel flex-1 basis-1/2 min-w-0">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Pengelolaan File</h2>
        <div class="flex border-b border-gray-300 mb-4">
          <button
            class="tab-button active py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-500 focus:outline-none"
            data-tab="text-extractor-tab">TextExtractor</button>
          <button class="tab-button py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-500 focus:outline-none"
            data-tab="exclude-me-tab">Exclude Me</button>
          <button class="tab-button py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-500 focus:outline-none"
            data-tab="just-me-tab">Just Me</button>
        </div>

        <div id="text-extractor-tab" class="tab-content">
          <p class="text-sm text-gray-600 mb-4">
            Klik tombol di bawah untuk menjalankan <code>TextEXtractor.py</code> dan melihat outputnya.
          </p>

          <!-- ‚ú® PROGRESS BAR SECTION ‚ú® -->
          <div id="progress-container" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-gray-800">üìä Extraction Progress</h4>
              <button id="cancel-task-btn"
                class="text-xs px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition">
                ‚ùå Cancel
              </button>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-6 mb-2 overflow-hidden">
              <div id="progress-bar"
                class="bg-primary-red h-6 rounded-full transition-all duration-300 flex items-center justify-center text-white text-xs font-bold"
                style="width: 0%">
                0%
              </div>
            </div>

            <!-- Status Info -->
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-700">
              <div><strong>Status:</strong> <span id="task-status" class="text-blue-600">Starting...</span></div>
              <div><strong>Progress:</strong> <span id="task-progress">0 / 0 files</span></div>
              <div><strong>Current File:</strong> <span id="current-file" class="text-gray-500 truncate block">‚Äî</span>
              </div>
              <div><strong>Duration:</strong> <span id="task-duration">0.0s</span></div>
              <div class="col-span-2"><strong>ETA:</strong> <span id="task-eta"
                  class="text-green-600">calculating...</span></div>
            </div>

            <!-- Task ID (for debugging) -->
            <div class="mt-2 text-xs text-gray-400">
              Task ID: <code id="task-id-display" class="bg-gray-100 px-1 rounded">‚Äî</code>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 mb-4">
            <div class="flex items-center gap-3">
              <label class="w-40 text-sm text-gray-700 font-medium">Folder Output</label>
              <input id="output-dir-input" type="text" placeholder="cth: C:/Users/Name/Output"
                class="flex-grow p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-w-0" />
              <button id="pick-output-dir-btn" class="btn-secondary font-bold py-2 px-3 rounded-md whitespace-nowrap">
                Pilih‚Ä¶
              </button>
            </div>
            <div class="flex items-center gap-3">
              <label class="w-40 text-sm text-gray-700 font-medium">Nama File</label>
              <input id="output-name-input" type="text" placeholder="Output.txt"
                class="flex-grow p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 min-w-0" />
            </div>
          </div>
          <div class="flex items-center gap-3 mb-2">
            <input id="remove-blank-lines-checkbox" type="checkbox" class="form-checkbox text-blue-500 rounded">
            <label for="remove-blank-lines-checkbox" class="text-sm text-gray-700 font-medium">
              Hapus baris kosong dari Output
            </label>
          </div>

          <!-- Extraction Mode Toggle -->
          <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-md border border-gray-200">
            <input id="use-async-extraction" type="checkbox" class="form-checkbox text-blue-500 rounded" checked>
            <label for="use-async-extraction" class="text-sm text-gray-700 font-medium">
              üöÄ Gunakan Async Extraction (dengan Progress Bar)
            </label>
            <span class="ml-auto text-xs text-gray-500">üí° Uncheck jika ada masalah</span>
          </div>

          <button id="run-text-extractor-btn"
            class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md focus:ring-2 transition-colors">
            Jalankan TextEXtractor.py
          </button>

          <!-- Open Output Folder Button -->
          <button id="open-output-folder-btn"
            class="w-full mt-3 btn-secondary text-gray-700 font-medium py-2 px-4 rounded-md border hover:bg-gray-50 transition-colors">
            üìÇ Buka Folder Output Directory
          </button>

          <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">
              Output: <span id="output-metrics" class="text-sm text-gray-500">(‚Äî)</span>
            </h3>

            <pre id="output-display"
              class="bg-gray-100 p-4 rounded-md text-sm text-gray-700 whitespace-pre-wrap h-96 overflow-y-auto border border-gray-300">Tekan tombol untuk memulai...</pre>
          </div>
        </div>

        <div id="exclude-me-tab" class="tab-content hidden">
          <p class="text-sm text-gray-600 mb-4">
            Edit nama file atau folder yang ingin Anda kecualikan. Setiap nama harus berada di baris baru.
          </p>
          <textarea id="exclude-list-textarea"
            class="w-full h-64 p-2 border rounded-md font-mono text-sm focus:outline-none border-gray-300"></textarea>
          <button id="save-exclude-btn"
            class="w-full mt-4 btn-primary text-white font-bold py-2 px-4 rounded-md">Simpan</button>
        </div>
        <div id="just-me-tab" class="tab-content hidden">
          <p class="text-sm text-gray-600 mb-2">
            <strong>Just Me (Inclusion Filter):</strong> Hanya file/folder yang cocok dengan pattern di bawah yang akan
            di-extract.
          </p>
          <p class="text-xs text-gray-500 mb-4">
            üí° <strong>Tips:</strong> Tambahkan nama file (e.g., <code>app.py</code>, <code>UserController.js</code>)
            atau path folder (e.g., <code>src/</code>, <code>components/</code>).
            Kosongkan untuk memproses semua file (subject to exclusions).
            Supports nested files ‚Äì all subdirectories akan di-scan untuk mencari file yang match.
          </p>

          <textarea id="just-me-textarea"
            class="w-full h-64 p-2 border rounded-md font-mono text-sm focus:outline-none border-gray-300"></textarea>

          <button id="save-just-me-btn" class="w-full mt-4 btn-primary text-white font-bold py-2 px-4 rounded-md">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Status & Activity -->
    <section id="status-panel" class="panel">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-gray-800">Status & Penjelasan</h3>
        <span id="statusMessage" class="text-sm text-gray-500"></span>
      </div>
      <hr class="my-3">
      <ul id="activity-log"
        class="text-sm text-gray-700 font-mono whitespace-pre-wrap space-y-1 max-h-56 overflow-y-auto flex flex-col-reverse">
      </ul>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const projectPathInput = document.getElementById('project-path-input');
      const setPathBtn = document.getElementById('set-path-btn');
      const fileTreeElement = document.getElementById('file-tree');
      const runNameExtractorBtn = document.getElementById('run-name-extractor-btn');
      const includeFilesCheckbox = document.getElementById('include-files-checkbox');
      const includeSizeCheckbox = document.getElementById('include-size-checkbox');
      const runTextExtractorBtn = document.getElementById('run-text-extractor-btn');
      const outputDisplay = document.getElementById('output-display');
      const excludeListTextarea = document.getElementById('exclude-list-textarea');
      const saveExcludeBtn = document.getElementById('save-exclude-btn');
      const pickFolderBtn = document.getElementById('pick-folder-btn');
      const activityLog = document.getElementById('activity-log');
      const statusMessage = document.getElementById('statusMessage');
      const outputDirInput = document.getElementById('output-dir-input');
      const outputNameInput = document.getElementById('output-name-input');
      const pickOutputDirBtn = document.getElementById('pick-output-dir-btn');
      const removeBlankLinesCheckbox = document.getElementById('remove-blank-lines-checkbox');
      const metricsBadge = document.getElementById('output-metrics');
      const justMeTextarea = document.getElementById('just-me-textarea');
      const saveJustMeBtn = document.getElementById('save-just-me-btn');
      const openOutputFolderBtn = document.getElementById('open-output-folder-btn');
      const useAsyncExtractionCheckbox = document.getElementById('use-async-extraction');

      // ===== PROGRESS BAR ELEMENTS =====
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const taskStatus = document.getElementById('task-status');
      const taskProgress = document.getElementById('task-progress');
      const currentFileSpan = document.getElementById('current-file');
      const taskDuration = document.getElementById('task-duration');
      const taskEta = document.getElementById('task-eta');
      const taskIdDisplay = document.getElementById('task-id-display');
      const cancelTaskBtn = document.getElementById('cancel-task-btn');

      let currentTaskId = null;
      let progressPollInterval = null;

      // ===== PROGRESS TRACKING FUNCTIONS =====
      const showProgressBar = (taskId) => {
        currentTaskId = taskId;
        taskIdDisplay.textContent = taskId;
        progressContainer.classList.remove('hidden');
        resetProgressUI();
        startProgressPolling();
      };

      const hideProgressBar = () => {
        progressContainer.classList.add('hidden');
        stopProgressPolling();
        currentTaskId = null;
      };

      const resetProgressUI = () => {
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        taskStatus.textContent = 'Starting...';
        taskProgress.textContent = '0 / 0 files';
        currentFileSpan.textContent = '‚Äî';
        taskDuration.textContent = '0.0s';
        taskEta.textContent = 'calculating...';
      };

      const updateProgressUI = (data) => {
        const progress = Math.round(data.progress || 0);
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;

        taskStatus.textContent = data.status || 'running';
        taskStatus.className = data.status === 'completed' ? 'text-green-600' :
          data.status === 'failed' ? 'text-red-600' :
            data.status === 'cancelled' ? 'text-gray-600' : 'text-blue-600';

        const processed = data.processed_files || 0;
        const total = data.total_files || 0;
        taskProgress.textContent = `${processed} / ${total} files`;

        currentFileSpan.textContent = data.current_file || '‚Äî';
        currentFileSpan.title = data.current_file || ''; // Full path on hover

        const duration = data.duration || 0;
        taskDuration.textContent = duration.toFixed(1) + 's';

        taskEta.textContent = data.eta || 'calculating...';

        // Auto-hide pada completion
        if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
          setTimeout(() => {
            if (data.status === 'completed') {
              appendLog(`‚úÖ Extraction completed! ${processed} files in ${duration.toFixed(1)}s`, 'success');
            } else if (data.status === 'failed') {
              appendLog(`‚ùå Extraction failed: ${data.error || 'unknown error'}`, 'error');
            } else if (data.status === 'cancelled') {
              appendLog(`‚ö†Ô∏è Extraction cancelled by user`, 'info');
            }
            hideProgressBar();
          }, 3000); // Hide after 3 seconds
        }
      };

      const startProgressPolling = () => {
        if (!currentTaskId) return;

        progressPollInterval = setInterval(async () => {
          if (!currentTaskId) {
            stopProgressPolling();
            return;
          }

          try {
            const res = await fetch(`/tasks/task_status/${currentTaskId}`);
            const data = await res.json();

            if (res.ok && data && data.success) {
              // API returns { success: true, task_info: {...} }
              const taskInfo = data.task_info || data;
              updateProgressUI(taskInfo);

              // Stop polling jika sudah selesai
              if (['completed', 'failed', 'cancelled'].includes(taskInfo.status)) {
                stopProgressPolling();

                // Refresh output jika completed
                if (taskInfo.status === 'completed') {
                  // Fetch result from task_result endpoint
                  try {
                    const resultRes = await fetch(`/tasks/task_result/${currentTaskId}`);
                    if (resultRes.ok) {
                      const resultText = await resultRes.text();
                      outputDisplay.textContent = resultText || 'Extraction completed!';
                      await refreshOutputMetrics();
                    }
                  } catch (e) {
                    console.error('Failed to load task result:', e);
                  }
                }
              }
            } else {
              appendLog(`‚ö†Ô∏è Failed to get task status: ${data?.error || 'unknown'}`, 'error');
              stopProgressPolling();
              hideProgressBar();
            }
          } catch (e) {
            console.error('Progress polling error:', e);
            stopProgressPolling();
            hideProgressBar();
          }
        }, 1000); // Poll every 1 second
      };

      const stopProgressPolling = () => {
        if (progressPollInterval) {
          clearInterval(progressPollInterval);
          progressPollInterval = null;
        }
      };

      // Cancel task handler
      cancelTaskBtn.addEventListener('click', async () => {
        if (!currentTaskId) return;

        cancelTaskBtn.disabled = true;
        try {
          const res = await fetch(`/tasks/cancel_task/${currentTaskId}`, { method: 'POST' });
          const data = await res.json();

          if (res.ok && data.success) {
            appendLog('üõë Task cancellation requested', 'info');
            taskStatus.textContent = 'cancelling...';
          } else {
            appendLog(`‚ùå Failed to cancel: ${data.error || 'unknown'}`, 'error');
          }
        } catch (e) {
          appendLog(`‚ùå Cancel error: ${e.message}`, 'error');
        } finally {
          cancelTaskBtn.disabled = false;
        }
      });

      // ---- Top nav chips: scroll & set active ----
      const navChips = document.querySelectorAll('.nav-chip');
      navChips.forEach(chip => {
        chip.addEventListener('click', () => {
          const target = chip.getAttribute('data-target');
          const el = document.querySelector(target);
          if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
          navChips.forEach(c => c.classList.remove('active'));
          chip.classList.add('active');

          // sinkronkan tab saat klik chips
          if (target === '#exclude-me-tab') {
            document.querySelector('.tab-button[data-tab="exclude-me-tab"]')?.click();
          }
          if (target === '#text-extractor-tab') {
            document.querySelector('.tab-button[data-tab="text-extractor-tab"]')?.click();
          }
          if (target === '#just-me-tab') {
            document.querySelector('.tab-button[data-tab="just-me-tab"]')?.click();
          }
        });
      });

      // ---- Tab switching: hide/show konten + load Just Me on demand ----
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', async () => {
          // sembunyikan semua panel konten
          document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
          // reset state tombol
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

          const target = btn.getAttribute('data-tab');
          document.getElementById(target)?.classList.remove('hidden');
          btn.classList.add('active');

          // lazy load whitelist just_me saat tab-nya dibuka
          if (target === 'just-me-tab') {
            await ensureJustMeLoaded();
          }
        });
      });

      // ---- Prefill input dari config saat halaman load ----
      (async function prefillFromConfig() {
        try {
          const r = await fetch('/config_summary');
          const j = await r.json();
          if (!r.ok || !j.success) return;

          if (j.target_folder) {
            projectPathInput.value = j.target_folder.replace(/\\/g, '/');
            appendLog(`Project path terdeteksi: ${projectPathInput.value}`, 'info');
            statusMessage.textContent = `Path terdeteksi: ${projectPathInput.value}`;
          }
          if (j.output_dir) {
            outputDirInput.value = j.output_dir.replace(/\\/g, '/');
          }
          if (j.output_name) {
            outputNameInput.value = j.output_name;
          }
          if (j.output_file) {
            appendLog(`Output akan ditulis ke: ${j.output_file}`, 'success');
            statusMessage.textContent = `Output: ${j.output_file}`;
          }
          await refreshOutputMetrics();
        } catch (e) { /* no-op */ }
      })();

      async function refreshOutputMetrics() {
        try {
          const r = await fetch('/output_metrics');
          const j = await r.json();
          if (r.ok && j.success) {
            metricsBadge.textContent = j.exists ? `(${j.words} kata ¬∑ ${j.tokens} token)` : '(0 kata ¬∑ 0 token)';
          } else metricsBadge.textContent = '(‚Äî)';
        } catch { metricsBadge.textContent = '(‚Äî)'; }
      }

      async function ensureJustMeLoaded() {
        if (!justMeTextarea || justMeTextarea.dataset.loaded) return;
        try {
          const r = await fetch('/manage_just_me');
          const j = await r.json();
          if (r.ok && j.success) {
            justMeTextarea.value = j.content || '';
            justMeTextarea.dataset.loaded = '1';
          } else {
            appendLog(`Gagal memuat just_me: ${j.error || 'unknown'}`, 'error');
          }
        } catch (e) {
          appendLog(`Gagal memuat just_me: ${e}`, 'error');
        }
      }

      function appendLog(text, type = 'info') {
        const li = document.createElement('li');
        li.classList.add('fade-in');
        const time = new Date().toLocaleTimeString();
        li.textContent = `[${time}] ${text}`;
        li.className += (type === 'error' ? ' primary-red' : type === 'success' ? ' text-green-700' : ' text-gray-700');
        activityLog.insertBefore(li, activityLog.firstChild); // terbaru di atas
      }

      // --- Drag & Drop ke Exclude Me ---
      const normalizeList = (text) => {
        return text.split(/\r?\n|,/g).map(s => s.trim()).filter(Boolean);
      };

      // gabung unik ke textarea target
      const addToListTextarea = (targetTextarea, items) => {
        const existing = normalizeList(targetTextarea.value);
        const set = new Set(existing);
        items.forEach(s => set.add(s));
        targetTextarea.value = Array.from(set).join('\n');
      };

      // adapter lama biar kode lain gak rusak
      const addToExcludeTextarea = (items) => addToListTextarea(excludeListTextarea, items);
      // NEW: untuk just_me
      const addToJustMeTextarea = (items) => addToListTextarea(justMeTextarea, items);

      excludeListTextarea.addEventListener('dragover', (e) => {
        e.preventDefault(); e.dataTransfer.dropEffect = 'copy';
        excludeListTextarea.classList.add('drop-target');
      });
      excludeListTextarea.addEventListener('dragleave', () => {
        excludeListTextarea.classList.remove('drop-target');
      });
      excludeListTextarea.addEventListener('drop', (e) => {
        e.preventDefault(); excludeListTextarea.classList.remove('drop-target');
        const text = e.dataTransfer.getData('text/plain') || '';
        if (!text) return;
        const items = normalizeList(text);
        addToExcludeTextarea(items);
      });

      // --- DnD ke JUST_ME ---
      justMeTextarea.addEventListener('dragover', (e) => {
        e.preventDefault(); e.dataTransfer.dropEffect = 'copy';
        justMeTextarea.classList.add('drop-target');
      });
      justMeTextarea.addEventListener('dragleave', () => {
        justMeTextarea.classList.remove('drop-target');
      });
      justMeTextarea.addEventListener('drop', (e) => {
        e.preventDefault(); justMeTextarea.classList.remove('drop-target');
        const text = e.dataTransfer.getData('text/plain') || '';
        if (!text) return;
        const items = normalizeList(text);
        addToJustMeTextarea(items);
      });


      // --- Build tree helpers ---
      const createFileElement = (name, size) => {
        const element = document.createElement('div');
        element.className = "flex items-center space-x-2 pl-4 py-1 text-sm text-gray-700 hover:bg-gray-100 rounded-md";
        element.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <span>${name}</span>
          <span class="ml-auto text-xs text-gray-500">${size}</span>
        `;
        makeDraggable(element, name);
        return element;
      };

      const createFolderElement = (name, size) => {
        const element = document.createElement('div');
        element.className = "group";
        element.innerHTML = `
          <div class="collapsible-header flex items-center space-x-2 py-2 px-3 hover:bg-gray-200 rounded-md transition-colors duration-200">
            <div class="toggle-icon-container">
              <svg class="folder-icon h-4 w-4 text-gray-500 group-hover:text-gray-700 transform" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 group-hover:text-gray-700"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v13.5z"></path>
            </svg>
            <span class="text-sm font-medium text-gray-800">${name}</span>
            <span class="ml-auto text-xs text-gray-500">${size}</span>
          </div>
          <div class="collapsible-content pl-6 pt-1 space-y-1"></div>
        `;
        const header = element.querySelector('.collapsible-header');
        makeDraggable(header, name);
        return element;
      };

      const makeDraggable = (el, label) => {
        el.setAttribute('draggable', 'true');
        el.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', label);
          e.dataTransfer.effectAllowed = 'copy';
        });
      };

      const buildFileTree = (lines) => {
        const tree = {};
        const validLines = lines.filter(line => line.includes(';'));
        if (validLines.length === 0) {
          fileTreeElement.innerHTML = `<div class="text-center text-sm font-medium text-gray-500">Tidak ada item yang ditemukan.</div>`;
          return;
        }
        const firstLineParts = validLines[0].split(';');
        const rootPath = firstLineParts[0].trim();

        fileTreeElement.innerHTML = '';

        validLines.forEach(line => {
          const lineParts = line.split(';');
          if (lineParts.length < 2) return;
          const fullPath = lineParts[0].trim();
          const itemType = lineParts[1].trim();
          const formattedSize = (lineParts.length > 3) ? lineParts[3].trim() : '';

          const relativePath = fullPath.substring(rootPath.length).replace(/\\/g, '/').replace(/^\//, '');
          if (!relativePath) return;

          const parts = relativePath.split('/');
          let currentLevel = tree;

          parts.forEach((part, index) => {
            if (!currentLevel[part]) {
              const isFile = (itemType === '[FILE]');
              currentLevel[part] = {
                isFile: isFile && index === parts.length - 1,
                children: {},
                size: formattedSize
              };
            }
            if (index < parts.length - 1) { currentLevel = currentLevel[part].children; }
          });
        });

        const renderTree = (node, parentElement) => {
          for (const key in node) {
            const item = node[key];
            const sizeText = item.size || '';
            if (item.isFile) {
              const fileElement = createFileElement(key, sizeText);
              parentElement.appendChild(fileElement);
            } else {
              const folderElement = createFolderElement(key, sizeText);
              const contentElement = folderElement.querySelector('.collapsible-content');
              parentElement.appendChild(folderElement);
              renderTree(item.children, contentElement);
            }
          }
        };
        renderTree(tree, fileTreeElement);

        document.querySelectorAll('.toggle-icon-container').forEach(iconContainer => {
          iconContainer.addEventListener('click', () => {
            const content = iconContainer.closest('.group').querySelector('.collapsible-content');
            const icon = iconContainer.querySelector('.folder-icon');
            if (content.style.display === "none" || content.style.display === "") {
              content.style.display = "block";
              icon.classList.add('rotated');
            } else {
              content.style.display = "none";
              icon.classList.remove('rotated');
            }
          });
        });
      };

      const buildFileTreeFromJson = (items, includeSize) => {
        if (!items.length) {
          fileTreeElement.innerHTML = `<div class="text-center text-sm font-medium text-gray-500">Tidak ada item ditemukan.</div>`;
          return;
        }
        const paths = items.map(it => it.path.replace(/\\/g, '/'));
        let root = paths[0];
        for (const p of paths.slice(1)) {
          let i = 0; while (i < root.length && i < p.length && root[i] === p[i]) i++;
          root = root.slice(0, root.slice(0, i).lastIndexOf('/') + 1);
        }
        const tree = {};
        const nodeMap = {};

        const attach = (fullPath, type, sizeText) => {
          const rel = fullPath.replace(/\\/g, '/').replace(root, '').replace(/^\/+/, '');
          if (!rel) return;
          const parts = rel.split('/');
          let current = tree;
          let curPath = root.endsWith('/') ? root.slice(0, -1) : root;
          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            curPath = curPath + '/' + part;
            current[part] = current[part] || { isFile: false, children: {}, name: part, path: curPath, size: "" };
            if (i === parts.length - 1) {
              if (type === 'FILE') current[part].isFile = true;
              if (sizeText) current[part].size = sizeText;
              nodeMap[curPath] = current[part];
            } else {
              current = current[part].children;
            }
          }
        };
        items.forEach(it => attach(it.path, it.type, it.formatted_size || ''));

        fileTreeElement.innerHTML = '';
        const renderTree = (node, parent) => {
          Object.keys(node).sort().forEach(key => {
            const item = node[key];
            if (item.isFile) {
              parent.appendChild(createFileElement(item.name, item.size || ''));
            } else {
              const el = createFolderElement(item.name, item.size || '');
              const content = el.querySelector('.collapsible-content');
              parent.appendChild(el);

              el.querySelector('.toggle-icon-container').addEventListener('click', async () => {
                const isHidden = (content.style.display === "" || content.style.display === "none");
                if (isHidden) {
                  content.style.display = "block";
                  el.querySelector('.folder-icon').classList.add('rotated');

                  if (!item.size && includeSize) {
                    try {
                      const r = await fetch(`/size?path=${encodeURIComponent(item.path)}`);
                      const j = await r.json();
                      if (j.success) {
                        item.size = j.formatted_size;
                        el.querySelector('.ml-auto').textContent = item.size;
                      }
                    } catch (e) { /* ignore */ }
                  }
                } else {
                  content.style.display = "none";
                  el.querySelector('.folder-icon').classList.remove('rotated');
                }
              });

              renderTree(item.children, content);
            }
          });
        };
        renderTree(tree, fileTreeElement);
      };

      // ===== helper untuk call endpoint =====
      const handleButtonClick = async (endpoint, button, message, payload = {}) => {
        statusMessage.textContent = message;
        appendLog(message, 'info');
        button.disabled = true;

        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': endpoint === '/run_textextractor' ? 'text/plain' : 'application/json'
            },
            body: JSON.stringify(payload)
          });

          const isTextExtractor = endpoint === '/run_textextractor';
          const data = isTextExtractor ? await response.text() : await response.json();

          if (!response.ok) {
            const ct = response.headers.get('content-type') || '';
            let j = null;
            if (ct.includes('application/json')) {
              try { j = JSON.parse(isTextExtractor ? data : JSON.stringify(data)); } catch { }
            }

            if (j && j.need_output_path) {
              statusMessage.textContent = 'Memerlukan folder output. Membuka dialog...';
              appendLog(`Server meminta pemilihan folder output (${j.reason}).`, 'info');
              try {
                const resPick = await fetch('/pick_output_folder');
                const pick = await resPick.json();
                if (resPick.ok && pick.success) {
                  const normalized = (pick.path || '').replace(/\\/g, '/');
                  outputDirInput.value = normalized;
                  if (j.suggested_name && !outputNameInput.value.trim()) {
                    outputNameInput.value = j.suggested_name;
                  }
                  appendLog(`Output folder terpilih: ${normalized}`, 'success');
                  statusMessage.textContent = 'Folder output dipilih. Menjalankan ulang TextEXtractor...';
                  const rerunPayload = {
                    ...(payload.path ? { path: payload.path } : {}),
                    ...(outputDirInput.value ? { output_dir: outputDirInput.value } : {}),
                    ...(outputNameInput.value ? { output_name: outputNameInput.value.trim() } : {}),
                  };
                  await handleButtonClick('/run_textextractor', button, 'Menjalankan ulang TextEXtractor...', rerunPayload);
                  return;
                } else {
                  const err = pick.error || 'Gagal memilih folder output.';
                  statusMessage.textContent = `‚ùå ${err}`;
                  appendLog(`Gagal memilih folder output: ${err}`, 'error');
                  return;
                }
              } catch (e) {
                statusMessage.textContent = `‚ùå Gagal membuka dialog: ${e.message}`;
                appendLog(`Kesalahan saat membuka dialog output: ${e.message}`, 'error');
                return;
              }
            }

            const errMsg = isTextExtractor ? data : (data && data.error);
            statusMessage.textContent = `‚ùå ${errMsg || response.statusText}`;
            appendLog(`Terjadi kesalahan: ${errMsg || response.statusText}`, 'error');
            return;
          }

          // Mapping sukses per-endpoint
          if (endpoint === '/run_nameextractor_json') {
            const items = data.items || [];
            buildFileTreeFromJson(items, includeSizeCheckbox.checked);
            statusMessage.textContent = `‚úÖ Struktur diperbarui (${items.length} item).`;
            appendLog('NamesExtractor JSON berhasil dijalankan.', 'success');

          } else if (endpoint === '/run_nameextractor') {
            buildFileTree(data.output.split('\n').filter(line => line.trim() !== ''));
            statusMessage.textContent = '‚úÖ Struktur diperbarui.';
            appendLog("NamesExtractor.py (legacy) berhasil dijalankan. Output ada di 'OutputAllNames.txt'.", 'success');

          } else if (endpoint === '/run_textextractor') {
            outputDisplay.textContent = data;
            statusMessage.textContent = '‚úÖ TextEXtractor selesai.';
            appendLog('TextEXtractor selesai. Output ditampilkan.', 'success');
            await refreshOutputMetrics();

          } else if (endpoint === '/set_path') {
            statusMessage.textContent = data.message || 'Path disimpan.';
            appendLog('Path berhasil diatur dan disimpan ke config.json.', 'success');

          } else if (endpoint === '/manage_exclude_file') {
            statusMessage.textContent = data.message || 'Daftar pengecualian disimpan.';
            appendLog('Daftar pengecualian berhasil disimpan.', 'success');

          } else {
            statusMessage.textContent = data.message || 'Selesai.';
            appendLog(data.message || 'Selesai.', 'success');
          }
        } catch (error) {
          statusMessage.textContent = `‚ùå ${error.message}`;
          appendLog(`Terjadi kesalahan jaringan: ${error.message}`, 'error');
        } finally {
          button.disabled = false;
        }
      };

      const cleanPath = (raw) => {
        let s = (raw || '').trim();
        while ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
          s = s.slice(1, -1).trim();
        }
        s = s.replace(/^["'‚Äú‚Äù‚Äò‚Äô]+|["'‚Äú‚Äù‚Äò‚Äô]+$/g, '');
        s = s.replace(/\\/g, '/');
        s = s.replace(/\/{2,}/g, '/');
        return s;
      };

      // Set Path
      setPathBtn.addEventListener('click', () => {
        const raw = document.getElementById('project-path-input').value;
        const normalizedPath = cleanPath(raw);
        if (normalizedPath) {
          handleButtonClick('/set_path', setPathBtn, 'Mengatur path...', { path: normalizedPath });
        } else {
          outputDisplay.textContent = '‚ùå Masukkan path yang valid.';
        }
      });

      // NamesExtractor
      runNameExtractorBtn.addEventListener('click', () => {
        const normalizedPath = cleanPath(projectPathInput.value);
        const payload = {
          include_files: includeFilesCheckbox.checked,
          include_size: includeSizeCheckbox.checked,
          ...(normalizedPath ? { path: normalizedPath } : {})
        };
        handleButtonClick('/run_nameextractor_json', runNameExtractorBtn, 'Menjalankan NamesExtractor.py... Mohon tunggu...', payload);
      });

      // TextExtractor (SUPPORTS BOTH: async with progress bar OR sync legacy mode)
      runTextExtractorBtn.addEventListener('click', async () => {
        const normalizedPath = cleanPath(projectPathInput.value);
        const useAsync = useAsyncExtractionCheckbox.checked;

        // Validate inputs
        if (!normalizedPath) {
          statusMessage.textContent = '‚ùå Path project belum diatur!';
          appendLog('Error: Path project kosong', 'error');
          return;
        }

        if (!outputDirInput.value || !outputNameInput.value) {
          statusMessage.textContent = '‚ùå Output directory dan filename harus diisi!';
          appendLog('Error: Output directory atau filename kosong', 'error');
          return;
        }

        runTextExtractorBtn.disabled = true;

        // === MODE 1: ASYNC EXTRACTION (NEW) ===
        if (useAsync) {
          const payload = {
            folder_path: normalizedPath,
            output_dir: cleanPath(outputDirInput.value),
            output_name: outputNameInput.value.trim(),
            remove_blank_lines: !!removeBlankLinesCheckbox?.checked
          };

          statusMessage.textContent = 'üöÄ Starting async extraction...';
          appendLog('Starting async text extraction task...', 'info');

          try {
            const res = await fetch('/tasks/start_extraction', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (res.ok && data.success) {
              const taskId = data.task_id;
              statusMessage.textContent = `‚úÖ Task started: ${taskId}`;
              appendLog(`Async extraction task created: ${taskId}`, 'success');

              // Show progress bar and start polling
              showProgressBar(taskId);
            } else {
              const err = data.error || 'Failed to start extraction';
              statusMessage.textContent = `‚ùå ${err}`;
              appendLog(`Failed to start extraction: ${err}`, 'error');
            }
          } catch (e) {
            statusMessage.textContent = `‚ùå Network error: ${e.message}`;
            appendLog(`Network error: ${e.message}`, 'error');
          } finally {
            runTextExtractorBtn.disabled = false;
          }
        }
        // === MODE 2: SYNC EXTRACTION (LEGACY - FALLBACK) ===
        else {
          const payload = {
            path: normalizedPath,
            output_dir: cleanPath(outputDirInput.value),
            output_name: outputNameInput.value.trim(),
            remove_blank_lines: !!removeBlankLinesCheckbox?.checked
          };

          statusMessage.textContent = '‚è≥ Running sync extraction (legacy mode)...';
          appendLog('Using sync extraction (old method)...', 'info');

          try {
            const res = await fetch('/run_textextractor', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'text/plain' },
              body: JSON.stringify(payload)
            });

            const data = await res.text();

            if (res.ok) {
              outputDisplay.textContent = data;
              statusMessage.textContent = '‚úÖ Sync extraction completed!';
              appendLog('Sync extraction finished successfully', 'success');
              await refreshOutputMetrics();
            } else {
              statusMessage.textContent = `‚ùå Error: ${data}`;
              appendLog(`Sync extraction failed: ${data}`, 'error');
            }
          } catch (e) {
            statusMessage.textContent = `‚ùå Network error: ${e.message}`;
            appendLog(`Network error: ${e.message}`, 'error');
          } finally {
            runTextExtractorBtn.disabled = false;
          }
        }
      });

      // Tabs
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.add('hidden'));
          button.classList.add('active');
          document.getElementById(button.dataset.tab).classList.remove('hidden');

          if (button.dataset.tab === 'exclude-me-tab') {
            fetch('/manage_exclude_file')
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  excludeListTextarea.value = data.content;
                } else {
                  excludeListTextarea.value = `Gagal memuat file: ${data.error}`;
                }
              })
              .catch(error => {
                excludeListTextarea.value = `Gagal memuat: ${error.message}`;
              });
          }
        });
      });

      // Save Just_Me
      saveJustMeBtn.addEventListener('click', () => {
        const newContent = justMeTextarea.value;
        handleButtonClick(
          '/manage_just_me',
          saveJustMeBtn,
          'Menyimpan Just Me.',
          { content: newContent }
        );
      });

      // Save Exclude
      saveExcludeBtn.addEventListener('click', () => {
        const newContent = excludeListTextarea.value;
        handleButtonClick('/manage_exclude_file', saveExcludeBtn, 'Menyimpan...', { content: newContent });
      });

      // Pick folder project
      pickFolderBtn.addEventListener('click', async () => {
        pickFolderBtn.disabled = true;
        statusMessage.textContent = 'Membuka dialog folder...';
        appendLog('Membuka dialog pemilihan folder...', 'info');

        try {
          const res = await fetch('/pick_folder'); // GET
          const data = await res.json();

          if (res.ok && data.success) {
            const normalized = (data.path || '').replace(/\\/g, '/');
            projectPathInput.value = normalized;
            statusMessage.textContent = `‚úÖ Path terpilih: ${normalized}`;
            appendLog(`Path diperbarui dari dialog: ${normalized}`, 'success');

            const payload = {
              include_files: includeFilesCheckbox.checked,
              include_size: includeSizeCheckbox.checked,
              path: normalized
            };
            appendLog('Menjalankan NamesExtractor JSON untuk path terpilih...', 'info');
            await handleButtonClick('/run_nameextractor_json', runNameExtractorBtn, 'Memuat struktur‚Ä¶', payload);
          } else {
            const err = data.error || 'Gagal memilih folder.';
            statusMessage.textContent = `‚ùå ${err}`;
            appendLog(`Gagal memilih folder: ${err}`, 'error');
          }
        } catch (e) {
          statusMessage.textContent = `‚ùå Gagal: ${e.message}`;
          appendLog(`Terjadi kesalahan jaringan: ${e.message}`, 'error');
        } finally {
          pickFolderBtn.disabled = false;
        }
      });

      // Pick output folder
      pickOutputDirBtn.addEventListener('click', async () => {
        pickOutputDirBtn.disabled = true;
        statusMessage.textContent = 'Membuka dialog folder output...';
        appendLog('Membuka dialog pemilihan folder output...', 'info');

        try {
          const res = await fetch('/pick_output_folder'); // GET
          const data = await res.json();

          if (res.ok && data.success) {
            const normalized = (data.path || '').replace(/\\/g, '/');
            outputDirInput.value = normalized;
            statusMessage.textContent = `‚úÖ Output folder terpilih: ${normalized}`;
            appendLog(`Output folder diperbarui dari dialog: ${normalized}`, 'success');
          } else {
            const err = data.error || 'Gagal memilih folder output.';
            statusMessage.textContent = `‚ùå ${err}`;
            appendLog(`Gagal memilih folder output: ${err}`, 'error');
          }
        } catch (e) {
          statusMessage.textContent = `‚ùå Gagal: ${e.message}`;
          appendLog(`Terjadi kesalahan jaringan: ${e.message}`, 'error');
        } finally {
          pickOutputDirBtn.disabled = false;
        }
      });

      // Open output folder
      openOutputFolderBtn.addEventListener('click', async () => {
        openOutputFolderBtn.disabled = true;
        statusMessage.textContent = 'Membuka folder output...';
        appendLog('Membuka folder data/output di file explorer...', 'info');

        try {
          const res = await fetch('/open_output_folder');
          const data = await res.json();

          if (res.ok && data.success) {
            statusMessage.textContent = '‚úÖ Folder output dibuka';
            appendLog(data.message, 'success');
          } else {
            const err = data.error || 'Gagal membuka folder.';
            statusMessage.textContent = `‚ùå ${err}`;
            appendLog(`Gagal membuka folder: ${err}`, 'error');
          }
        } catch (e) {
          statusMessage.textContent = `‚ùå Gagal: ${e.message}`;
          appendLog(`Terjadi kesalahan: ${e.message}`, 'error');
        } finally {
          openOutputFolderBtn.disabled = false;
        }
      });

      // panggil metrics terakhir setelah semua binding siap
      (async () => { await refreshOutputMetrics(); })();
    });
  </script>
</body>

</html>