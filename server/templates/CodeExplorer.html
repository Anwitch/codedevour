<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Explorer - CodeDevour</title>

    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/visualizer.css') }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="visualizer-container">
        <!-- Header -->
        <div class="visualizer-header">
            <div>
                <button id="backBtn"
                    style="background: none; border: 1px solid #e5e7eb; color: #374151; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; margin-bottom: 0.5rem;"
                    onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'"
                    onclick="window.location.href='/'">
                    ‚Üê Back to Main
                </button>
                <h1 class="visualizer-title">üîç Code Explorer</h1>
                <p style="margin: 0.5rem 0 0; color: #666; font-size: 0.9rem;">
                    Interactive codebase dependency visualization
                </p>
            </div>

            <div class="visualizer-actions">
                <div class="stats-badge" id="stats-badge" style="display: none;">
                    <div class="stats-badge-item">
                        <span class="stats-badge-label">Files:</span>
                        <span class="stats-badge-value" id="file-count">0</span>
                    </div>
                    <div class="stats-badge-item">
                        <span class="stats-badge-label">Functions:</span>
                        <span class="stats-badge-value" id="function-count">0</span>
                    </div>
                </div>

                <button class="visualizer-btn visualizer-btn-primary" id="scan-btn">
                    üìä Scan Project
                </button>

                <button class="visualizer-btn visualizer-btn-secondary" id="refresh-btn" style="display: none;">
                    üîÑ Refresh
                </button>

                <button class="visualizer-btn visualizer-btn-secondary" id="clear-cache-btn" style="display: none;">
                    üóëÔ∏è Clear Cache
                </button>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel-container">
            <div id="filter-panel"></div>
        </div>

        <!-- Graph Container -->
        <div class="graph-container">
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading-overlay" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loading-text">Scanning project...</div>
            </div>

            <!-- Graph Controls -->
            <div class="graph-controls">
                <button class="graph-control-btn" id="reset-view-btn" title="Reset View">
                    ‚Üª
                </button>
                <button class="graph-control-btn" id="export-svg-btn" title="Export SVG">
                    üíæ
                </button>
                <button class="graph-control-btn" id="fullscreen-btn" title="Fullscreen">
                    ‚õ∂
                </button>
            </div>

            <!-- Legend -->
            <div class="graph-legend">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #DC143C;">Legend</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3572A5;"></div>
                    <span>Python Files</span>
                </div>
                <div class="legend-item">
                    <span style="font-size: 0.8rem; color: #666;">
                        ‚Ä¢ Size = Importance<br>
                        ‚Ä¢ Click = View Details<br>
                        ‚Ä¢ Drag = Reposition
                    </span>
                </div>
            </div>

            <!-- Bubble Graph -->
            <div id="bubble-graph"></div>
        </div>

        <!-- Details Sidebar -->
        <div class="details-sidebar-container">
            <div id="details-sidebar"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/visualizer/BubbleGraph.js') }}"></script>
    <script src="{{ url_for('static', filename='js/visualizer/DetailsSidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/visualizer/FilterPanel.js') }}"></script>

    <script>
        // Initialize components
        let bubbleGraph;
        let detailsSidebar;
        let filterPanel;
        let currentProjectPath = '';

        document.addEventListener('DOMContentLoaded', async () => {
            initializeComponents();
            attachEventListeners();
            await loadProjectPath();
            
            // Auto-scan if project path is available
            setTimeout(autoScanIfPossible, 500);
        });

        function initializeComponents() {
            // Initialize BubbleGraph
            bubbleGraph = new BubbleGraph('bubble-graph');

            // Initialize DetailsSidebar
            detailsSidebar = new DetailsSidebar('details-sidebar');

            // Initialize FilterPanel
            filterPanel = new FilterPanel('filter-panel');

            // Set up callbacks
            bubbleGraph.onNodeClick = handleNodeClick;
            bubbleGraph.onNodeHover = handleNodeHover;

            detailsSidebar.onFunctionClick = handleFunctionClick;
            detailsSidebar.onImportClick = handleImportClick;

            filterPanel.onFilterChange = handleFilterChange;
            filterPanel.onSearchChange = handleSearchChange;
        }

        function attachEventListeners() {
            // Scan button
            document.getElementById('scan-btn').addEventListener('click', scanProject);

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', () => {
                scanProject(true);
            });

            // Clear cache button
            document.getElementById('clear-cache-btn').addEventListener('click', clearCache);

            // Reset view button
            document.getElementById('reset-view-btn').addEventListener('click', () => {
                bubbleGraph.resetView();
            });

            // Export SVG button
            document.getElementById('export-svg-btn').addEventListener('click', () => {
                bubbleGraph.exportSVG();
            });

            // Fullscreen button
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        }

        async function loadProjectPath() {
            try {
                const response = await fetch('/config_summary');
                const data = await response.json();
                currentProjectPath = data.target_folder || '';
                
                // Debug logging
                console.log('Config loaded:', {
                    success: data.success,
                    target_folder: data.target_folder,
                    exclude_file: data.exclude_file,
                    just_me_file: data.just_me_file
                });
                
                if (!currentProjectPath) {
                    console.warn('No project path found in config');
                }
            } catch (error) {
                console.error('Failed to load project path:', error);
            }
        }

        async function scanProject(forceRefresh = false) {
            showLoading('Scanning project with filters...');

            try {
                // Step 1: Scan project
                const scanResponse = await fetch('/api/visualizer/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_path: currentProjectPath,
                        use_cache: !forceRefresh,
                        include_tests: false,
                        force_refresh: forceRefresh
                    })
                });

                const scanData = await scanResponse.json();

                if (scanData.status !== 'success') {
                    throw new Error(scanData.message || 'Scan failed');
                }

                // Update stats with filtering info
                updateStats(scanData);

                // Show filtering information if available
                if (scanData.filters_applied) {
                    console.log('Filters applied:', scanData.filters_applied);
                }

                // Step 2: Get graph data
                showLoading('Building graph...');

                const graphResponse = await fetch('/api/visualizer/graph');
                const graphData = await graphResponse.json();

                // Render graph
                bubbleGraph.render(graphData);

                // Show success
                hideLoading();
                document.getElementById('refresh-btn').style.display = 'inline-block';
                document.getElementById('clear-cache-btn').style.display = 'inline-block';

            } catch (error) {
                console.error('Scan failed:', error);
                alert('Failed to scan project: ' + error.message);
                hideLoading();
            }
        }

        async function clearCache() {
            try {
                showLoading('Clearing cache...');
                
                const response = await fetch('/api/visualizer/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_path: currentProjectPath
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('Cache cleared successfully!');
                    hideLoading();
                    
                    // Trigger a fresh scan
                    scanProject(true);
                } else {
                    throw new Error(result.message || 'Failed to clear cache');
                }
                
            } catch (error) {
                console.error('Clear cache failed:', error);
                alert('Failed to clear cache: ' + error.message);
                hideLoading();
            }
        }

        // Auto-scan when page loads if project path is available
        async function autoScanIfPossible() {
            if (currentProjectPath && currentProjectPath.trim()) {
                console.log('Auto-scanning project:', currentProjectPath);
                await scanProject(true); // Force refresh to get latest data
            } else {
                console.log('No project path available, waiting for user input');
                showLoading('No project path set. Please configure in the main app.');
            }
        }

        async function handleNodeClick(node) {
            console.log('Node clicked:', node);

            try {
                // Fetch file details
                const response = await fetch(`/api/visualizer/file/${encodeURIComponent(node.id)}`);
                const fileData = await response.json();

                // Show in sidebar
                detailsSidebar.showFileDetails(fileData);

            } catch (error) {
                console.error('Failed to load file details:', error);
            }
        }

        function handleNodeHover(node) {
            // Optional: Show tooltip
            console.log('Node hover:', node.id);
        }

        function handleFunctionClick(func) {
            console.log('Function clicked:', func);
            // Optional: Show function details modal
        }

        function handleImportClick(filepath) {
            console.log('Import clicked:', filepath);
            // Focus on the imported file
            bubbleGraph.focusNode(filepath);
        }

        function handleFilterChange(filters) {
            console.log('Filters changed:', filters);

            // Apply filters to graph
            const criteria = {};

            if (filters.language !== 'all') {
                criteria.language = filters.language;
            }

            if (filters.minSize > 0) {
                criteria.minSize = filters.minSize;
            }

            if (filters.maxSize < Infinity) {
                criteria.maxSize = filters.maxSize;
            }

            bubbleGraph.filterNodes(criteria);
        }

        function handleSearchChange(query) {
            console.log('Search:', query);
            bubbleGraph.searchNodes(query);
        }

        function updateStats(scanData) {
            document.getElementById('file-count').textContent = scanData.file_count || 0;
            document.getElementById('function-count').textContent = scanData.function_count || 0;
            document.getElementById('stats-badge').style.display = 'flex';
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function toggleFullscreen() {
            const container = document.querySelector('.graph-container');

            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>

</html>